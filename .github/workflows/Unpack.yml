name: 2. ‚ö° Auto Process on Close

on:
  issues:
    types: [closed]

jobs:
  unpack-selected:
    # –ó–∞–ø—É—Å–∫–∞–µ–º—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É Issue –µ—Å—Ç—å –º–µ—Ç–∫–∞ 'unzip-trigger'
    if: contains(github.event.issue.labels.*.name, 'unzip-trigger')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install 7-Zip
        run: sudo apt-get update && sudo apt-get install -y p7zip-full

      - name: Parse Config and Unzip
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # --- –ß–∏—Ç–∞–µ–º –ø–∞–ø–∫—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ Issue ---
          CUSTOM_DIR=$(echo "$ISSUE_BODY" | grep "TargetFolder:" | cut -d ':' -f 2 | xargs)
          
          if [ -z "$CUSTOM_DIR" ]; then
             BASE_DEST_DIR="unzipped_content"
             echo "‚ö†Ô∏è TargetFolder not set. Using default: $BASE_DEST_DIR"
          else
             BASE_DEST_DIR="$CUSTOM_DIR"
          fi
          
          echo "üìÇ Base Destination: $BASE_DEST_DIR"
          mkdir -p "$BASE_DEST_DIR"
          # ----------------------------------------

          # –ß–∏—Ç–∞–µ–º —Å—Ç—Ä–æ–∫–∏ Issue
          echo "$ISSUE_BODY" | while IFS= read -r line; do
            # –ò—â–µ–º –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ –≥–∞–ª–æ—á–∫–∏
            if [[ "$line" == *"- [x] "* ]]; then
              
              # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ –∞—Ä—Ö–∏–≤—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: ./Plugins/Data.zip)
              ARCHIVE_PATH=$(echo "${line:6}" | xargs)
              
              if [ -f "$ARCHIVE_PATH" ]; then
                 
                 # 1. –ü–æ–ª—É—á–∞–µ–º —á–∏—Å—Ç–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ (Data.zip)
                 FILENAME=$(basename "$ARCHIVE_PATH")
                 
                 # 2. –£–±–∏—Ä–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ (Data)
                 FOLDER_NAME="${FILENAME%.*}"
                 
                 # 3. –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –ø—É—Ç—å: unzipped_content/Data
                 FINAL_OUTPUT_DIR="$BASE_DEST_DIR/$FOLDER_NAME"
                 
                 echo "----------------------------------"
                 echo "üéØ Processing: '$ARCHIVE_PATH'"
                 echo "üìÇ Creating sub-folder: '$FINAL_OUTPUT_DIR'"
                 
                 # –°–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∞–ø–∫—É
                 mkdir -p "$FINAL_OUTPUT_DIR"

                 # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –í–ù–£–¢–†–¨ —ç—Ç–æ–π –ø–æ–¥–ø–∞–ø–∫–∏
                 if 7z x "$ARCHIVE_PATH" -o"$FINAL_OUTPUT_DIR" -y > /dev/null; then
                    echo "‚úÖ Success!"
                 else
                    echo "‚ùå Failed to unzip $ARCHIVE_PATH"
                 fi

              else
                 echo "‚ö†Ô∏è File not found: $ARCHIVE_PATH"
              fi
            fi
          done
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–∞–∑–æ–≤—É—é –ø–∞–ø–∫—É –¥–ª—è —à–∞–≥–∞ –∫–æ–º–º–∏—Ç–∞
          echo "SAVED_DEST_DIR=$BASE_DEST_DIR" >> $GITHUB_ENV

      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "üì¶ Unpacked archives into subfolders (Issue #${{ github.event.issue.number }})"
          # –ö–æ–º–º–∏—Ç–∏–º –≤—Å—ë –≤–Ω—É—Ç—Ä–∏ –±–∞–∑–æ–≤–æ–π –ø–∞–ø–∫–∏ (–≤–∫–ª—é—á–∞—è –Ω–æ–≤—ã–µ –ø–æ–¥–ø–∞–ø–∫–∏)
          file_pattern: '${{ env.SAVED_DEST_DIR }}/*'

      - name: Add Success Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_ID: ${{ github.event.issue.number }}
          FINAL_DIR: ${{ env.SAVED_DEST_DIR }}
        run: |
          gh issue comment "$ISSUE_ID" --body "‚úÖ **–ì–æ—Ç–æ–≤–æ!** –ö–∞–∂–¥—ã–π –∞—Ä—Ö–∏–≤ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω –≤ —Å–≤–æ—é –ø–æ–¥–ø–∞–ø–∫—É –≤–Ω—É—Ç—Ä–∏: \`$FINAL_DIR\`"
