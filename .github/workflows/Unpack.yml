name: 2. ‚ö° Auto Process on Close

on:
  issues:
    types: [closed]

jobs:
  unpack-selected:
    if: contains(github.event.issue.labels.*.name, 'unzip-trigger')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install 7-Zip
        run: sudo apt-get update && sudo apt-get install -y p7zip-full

      - name: Parse Config and Unzip
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # --- –õ–û–ì–ò–ö–ê –ü–ê–†–°–ò–ù–ì–ê –ü–ê–ü–ö–ò ---
          
          # –ò—â–µ–º —Å—Ç—Ä–æ–∫—É, –Ω–∞—á–∏–Ω–∞—é—â—É—é—Å—è —Å "TargetFolder:"
          # cut -d ':' -f 2 –±–µ—Ä–µ—Ç –≤—Å—ë –ø–æ—Å–ª–µ –¥–≤–æ–µ—Ç–æ—á–∏—è
          # xargs —É–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–±–µ–ª—ã –ø–æ –∫—Ä–∞—è–º
          CUSTOM_DIR=$(echo "$ISSUE_BODY" | grep "TargetFolder:" | cut -d ':' -f 2 | xargs)
          
          # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–∏–ª —Å—Ç—Ä–æ–∫—É –∏–ª–∏ –æ—Å—Ç–∞–≤–∏–ª –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç
          if [ -z "$CUSTOM_DIR" ]; then
             DEST_DIR="unzipped_content"
             echo "‚ö†Ô∏è TargetFolder not found in issue body. Using default: $DEST_DIR"
          else
             DEST_DIR="$CUSTOM_DIR"
          fi
          
          echo "üìÇ Final Destination: $DEST_DIR"
          mkdir -p "$DEST_DIR"
          # -----------------------------

          echo "$ISSUE_BODY" | while IFS= read -r line; do
            if [[ "$line" == *"- [x] "* ]]; then
              ARCHIVE=$(echo "${line:6}" | xargs)
              
              echo "----------------------------------"
              echo "üéØ Selected: '$ARCHIVE'"

              if [ -f "$ARCHIVE" ]; then
                 # -o–ü–∞–ø–∫–∞ (–±–µ–∑ –ø—Ä–æ–±–µ–ª–∞ –ø–æ—Å–ª–µ -o –¥–ª—è 7z)
                 7z x "$ARCHIVE" -o"$DEST_DIR" -y
              else
                 echo "‚ö†Ô∏è File not found: $ARCHIVE"
              fi
            fi
          done
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Ç—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å—Ä–µ–¥—ã, —á—Ç–æ–±—ã —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –µ–≥–æ –≤–∏–¥–µ–ª
          echo "SAVED_DEST_DIR=$DEST_DIR" >> $GITHUB_ENV

      # –ö–æ–º–º–∏—Ç–∏–º –∏–º–µ–Ω–Ω–æ –≤ —Ç—É –ø–∞–ø–∫—É, –∫–æ—Ç–æ—Ä—É—é –≤—ã—á–∏—Å–ª–∏–ª–∏ –≤—ã—à–µ
      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "üì¶ Unpacked files from Issue #${{ github.event.issue.number }}"
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞
          file_pattern: '${{ env.SAVED_DEST_DIR }}/*'

      - name: Add Success Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_ID: ${{ github.event.issue.number }}
          FINAL_DIR: ${{ env.SAVED_DEST_DIR }}
        run: |
          gh issue comment "$ISSUE_ID" --body "‚úÖ **–ì–æ—Ç–æ–≤–æ!** –§–∞–π–ª—ã —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω—ã –≤ –ø–∞–ø–∫—É: \`$FINAL_DIR\`"
